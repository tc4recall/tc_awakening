<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>互動式計數器</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden; /* Prevent scrollbar when pages overlap */
            transition: background 0.5s ease-in-out; /* Smooth background transition */
        }

        /* Dynamic body backgrounds based on active page */
        body.page1-bg {
            background: linear-gradient(to bottom right, #fcf6ba, #f7d794, #f5c476); /* Gold gradient for page 1 */
        }

        body.page2-bg {
            background: radial-gradient(circle at center, #fffbe0 0%, #fff1c8 25%, #ffda9f 50%, #ffc280 75%, #ffad66 100%); /* Radiant gradient for page 2 */
        }

        /* Container for both pages, adjusted for responsive padding */
        .page-container {
            width: 100%;
            max-width: 900px; /* Maximum width of the content area */
            padding: 20px; /* Padding inside the container */
            box-sizing: border-box;
            position: relative;
            display: flex; /* Use flexbox to center content */
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        /* Common section styling */
        .section {
            padding: 40px;
            text-align: center;
            position: absolute; /* Pages will overlap */
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%); /* Center horizontally and vertically */
        }

        /* Page 1 specific styling - this will be the "card" */
        #page1.section {
            /* Adjusted width to be 50% of its parent (page-container's content area)
               This creates a 25% margin on both sides visually within the 900px max-width area */
            width: 50%;
            min-width: 300px; /* Ensure a minimum readable width on smaller screens */
            background: linear-gradient(to bottom right, #fffde7, #fff9c4, #ffe082); /* Gold gradient for page 1 card */
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            color: #333; /* Default text color for page 1 */
        }

        /* Page 2 specific styling - now transparent and relies on body background */
        #page2.section {
            width: calc(100% - 40px); /* Fill page-container's content width */
            height: calc(100vh - 40px); /* Fill page-container's content height */
            
            background-color: transparent; /* Remove its own background */
            border-radius: 0;
            box-shadow: none;
            border: none;
            
            /* Use flexbox for vertical centering of content */
            display: flex;
            flex-direction: column;
            justify-content: center; /* Vertically center content */
            align-items: center; /* Horizontally center content */
            
            /* Text colors for page 2 elements, now directly applied */
            color: #4a0e0e; /* Default text color for page 2 */
            text-shadow: 1px 1px 3px rgba(255, 255, 255, 0.5); /* Subtle white text shadow */
        }

        #page2 h1 {
            color: #73bda6; /* Changed to requested color */
            font-size: 2.8rem; /* Larger title */
            line-height: 1.2;
            margin-bottom: 20px;
            font-weight: 900; /* Ensure extra bold for the title */
            white-space: nowrap; /* Keep title on one line */
            overflow: hidden; /* Hide overflow if it's too long */
            text-overflow: ellipsis; /* Add ellipsis if hidden */
        }
        #page2 #animatedDisplayCount {
            font-size: 10rem; /* Even larger number */
            font-weight: 900;
            line-height: 1;
            margin-bottom: 15px; /* Adjust margin for spacing */
            color: #202726; /* Changed to requested color */
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.8), 0 0 25px rgba(255, 255, 255, 0.6); /* Adjusted to white glow */
            letter-spacing: -2px;
            text-align: center; /* Ensure it is centered */
        }
        #page2 .secondary-text {
            font-size: 1.8rem;
            color: #d66b33; /* Changed to requested color */
            font-weight: 700;
            opacity: 0.9;
            margin-top: 30px; /* Moved further down */
        }

        /* Button specific styling */
        .button-glow {
            transition: all 0.3s ease;
        }
        .button-glow:hover {
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.6);
            transform: translateY(-2px);
        }

        /* Red circular 3D button for Page 1 */
        #enterButton.red-circle-button {
            background-color: #dc2626; /* Red-600 */
            border-radius: 9999px; /* Fully rounded for circle */
            width: 180px; /* Fixed width */
            height: 180px; /* Fixed height */
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2.5rem; /* Larger text */
            font-weight: 900;
            color: white;
            border: none;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.3), /* Deeper shadow */
                        0 0 0 8px rgba(252, 165, 165, 0.5); /* Red glowing ring */
            position: relative;
            transform-style: preserve-3d; /* For 3D effect */
            transition: all 0.2s ease-out;
            cursor: pointer;
            outline: none; /* Remove default outline */
        }

        #enterButton.red-circle-button:hover {
            background-color: #ef4444; /* Red-500 on hover */
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.4),
                        0 0 0 10px rgba(252, 165, 165, 0.7);
            transform: translateY(-4px) translateZ(10px); /* Lift and move forward */
        }

        #enterButton.red-circle-button:active {
            background-color: #b91c1c; /* Red-700 on active */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2),
                        0 0 0 6px rgba(252, 165, 165, 0.3);
            transform: translateY(2px) translateZ(0); /* Press down */
        }


        /* Message box styling */
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .message-box.show {
            opacity: 1;
            visibility: visible;
        }

        /* Animation for count up */
        @keyframes countUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-count-up {
            animation: countUp 0.5s ease-out forwards;
        }
    </style>
</head>
<body>
    <div class="page-container">
        <!-- Page 1: 裝置模擬區 (Input Page) -->
        <div id="page1" class="section">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">你同意罷免親共立委嗎？</h2>
            <p class="text-lg text-gray-700 mb-4">目前的同意人數: <span id="deviceCount" class="font-bold text-blue-600">載入中...</span></p>
            <button id="enterButton"
                    class="red-circle-button mx-auto mb-4">
                我同意
            </button>
            <p class="text-sm text-gray-500 mt-4">按下按鈕，讓魔法出現吧</p>
            <p class="text-sm mt-4 text-gray-500 opacity-70">
                當前使用者 ID: <span id="userIdDisplay" class="font-mono break-all text-gray-600">載入中...</span>
            </p>
        </div>

        <!-- Page 2: 總數顯示區 (Display Page) -->
        <div id="page2" class="section hidden">
            <h1 class="font-extrabold mb-4">台中覺醒｜展翅廢翔</h1>
            <div id="animatedDisplayCount" class="animate-count-up">0</div>
            <p class="secondary-text mt-4">個西屯南屯人同意罷免</p>
            <button id="backButton"
                    class="mt-8 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-5 rounded-lg shadow-md button-glow
                           focus:outline-none focus:ring-4 focus:ring-gray-300 transition duration-150 ease-in-out">
                返回輸入頁
            </button>
        </div>
    </div>

    <!-- Custom Message Box -->
    <div id="messageBox" class="message-box"></div>

    <script type="module">
        // Firebase 相關模組導入
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 全域變數，由 Canvas 環境提供
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId = null; // 初始化 userId

        const page1 = document.getElementById('page1');
        const page2 = document.getElementById('page2');
        const enterButton = document.getElementById('enterButton');
        const backButton = document.getElementById('backButton');
        const deviceCountElement = document.getElementById('deviceCount');
        const animatedDisplayCountElement = document.getElementById('animatedDisplayCount');
        const userIdDisplayElement = document.getElementById('userIdDisplay');
        const messageBox = document.getElementById('messageBox');

        let currentGlobalCount = 0; // 儲存目前的總數

        // 顯示訊息框
        function showMessage(message, duration = 3000) {
            messageBox.textContent = message;
            messageBox.classList.add('show');
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, duration);
        }

        // 頁面切換邏輯
        function showPage(pageId, animate = false, targetCount = 0, initialCount = 0) {
            if (pageId === 'page1') {
                page1.classList.remove('hidden');
                page1.style.opacity = '1';
                page2.classList.add('hidden');
                page2.style.opacity = '0';

                // 設定 body 背景為 page1 的漸層
                document.body.classList.add('page1-bg');
                document.body.classList.remove('page2-bg');
            } else if (pageId === 'page2') {
                page1.classList.add('hidden');
                page1.style.opacity = '0';
                page2.classList.remove('hidden');
                page2.style.opacity = '1';

                // 設定 body 背景為 page2 的漸層
                document.body.classList.add('page2-bg');
                document.body.classList.remove('page1-bg');

                if (animate) {
                    animateCount(targetCount, initialCount); // 傳遞初始值和目標值給動畫
                } else {
                    // 如果沒有動畫，直接顯示最新數字
                    animatedDisplayCountElement.textContent = currentGlobalCount;
                }
            }
        }

        // 數字動畫效果
        function animateCount(targetCount, initialCount) {
            // 決定動畫的起始點
            let startCount = initialCount;
            // 如果差距太大 (>50)，則從目標數字 - 50 開始動畫
            if (targetCount - initialCount > 50) {
                startCount = Math.max(0, targetCount - 50);
            }
            
            const duration = 500; // 動畫持續時間 (毫秒) - 0.5 秒
            let startTime = null;

            function step(currentTime) {
                if (!startTime) startTime = currentTime;
                const progress = (currentTime - startTime) / duration;

                if (progress < 1) {
                    const animatedValue = Math.floor(startCount + (targetCount - startCount) * progress);
                    animatedDisplayCountElement.textContent = animatedValue;
                    requestAnimationFrame(step);
                } else {
                    animatedDisplayCountElement.textContent = targetCount; // 確保最終顯示目標數字
                }
            }
            requestAnimationFrame(step);
        }

        // 初始化 Firebase
        window.onload = async function() {
            try {
                // 如果 firebaseConfig 為空，則顯示錯誤並退出
                if (Object.keys(firebaseConfig).length === 0) {
                    showMessage("錯誤: Firebase 配置未提供。請檢查環境設定。", 5000);
                    console.error("錯誤: Firebase 配置未提供。請檢查環境設定。");
                    return;
                }
                
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // 設定認證狀態變更監聽器
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplayElement.textContent = userId;
                        // 確保 Firestore 監聽器啟動只在認證完成後
                        setupFirestoreListener();
                    } else {
                        // 如果沒有用戶，嘗試匿名登錄或使用提供的令牌
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                            // 重新檢查 onAuthStateChanged 以更新 userId
                        } catch (error) {
                            showMessage(`認證失敗: ${error.message}`, 5000);
                            console.error("認證失敗:", error);
                            userIdDisplayElement.textContent = "無法獲取使用者 ID";
                        }
                    }
                });

                // 檢查 URL 參數來決定顯示哪個頁面
                const urlParams = new URLSearchParams(window.location.search);
                const displayMode = urlParams.get('mode');
                const prevCountParam = urlParams.get('prevCount');
                const targetCountParam = urlParams.get('targetCount');

                if (displayMode === 'display' && targetCountParam !== null) {
                    // 如果是顯示模式，則嘗試解析傳遞過來的數字
                    const parsedPrevCount = parseInt(prevCountParam) || 0;
                    const parsedTargetCount = parseInt(targetCountParam) || 0;
                    showPage('page2', true, parsedTargetCount, parsedPrevCount); // 播放動畫
                } else {
                    showPage('page1'); // 預設顯示第一頁 (輸入頁)
                }

            } catch (error) {
                showMessage(`初始化應用程式失敗: ${error.message}`, 5000);
                console.error("初始化應用程式失敗:", error);
            }
        };

        let counterDocRef; // Firestore 文件參考

        // 設定 Firestore 監聽器
        function setupFirestoreListener() {
            if (!db || !userId) {
                console.warn("Firestore 或使用者 ID 尚未準備好，無法設定監聽器。");
                return;
            }

            // 公開數據路徑: /artifacts/{appId}/public/data/counter/{documentId}
            const documentId = 'globalCounter'; // 我們將使用一個固定的 ID 來儲存全局計數
            counterDocRef = doc(db, `artifacts/${appId}/public/data/counter/${documentId}`);

            // 實時監聽計數器變化
            onSnapshot(counterDocRef, (docSnap) => {
                let fetchedCount = 0;
                if (docSnap.exists()) {
                    fetchedCount = docSnap.data().count;
                }

                // 確保計數從 50000 開始或至少是 50000
                if (fetchedCount < 50000) {
                    currentGlobalCount = 50000;
                    setDoc(counterDocRef, { count: 50000 }, { merge: true }).catch(e => console.error("初始化計數器失敗:", e));
                } else {
                    currentGlobalCount = fetchedCount;
                }

                deviceCountElement.textContent = currentGlobalCount; // 在 Page 1 上顯示

                // 如果 Page 2 當前是可見狀態且沒有正在進行動畫，則直接更新其顯示
                // 這裡的邏輯主要用於非點擊觸發的即時更新 (例如其他裝置增加數字)
                if (!page2.classList.contains('hidden') && animatedDisplayCountElement.textContent !== currentGlobalCount.toString()) {
                    // 為了避免動畫中途被非點擊事件的更新打斷，這裡只在非動畫觸發時更新
                    // 點擊事件觸發的動畫會確保正確的最終值
                    animatedDisplayCountElement.textContent = currentGlobalCount;
                }

            }, (error) => {
                showMessage(` Firestore 監聽錯誤: ${error.message}`, 5000);
                console.error("Firestore 監聽錯誤:", error);
                deviceCountElement.textContent = "錯誤";
                animatedDisplayCountElement.textContent = "錯誤";
            });
        }

        // Enter 按鈕點擊事件處理
        enterButton.addEventListener('click', async () => {
            if (!counterDocRef) {
                showMessage("Firebase 尚未初始化或使用者未登入。請稍候再試。", 3000);
                return;
            }

            enterButton.disabled = true; // 點擊後禁用按鈕以防止快速重複點擊
            enterButton.textContent = '更新中...';

            try {
                const docSnap = await getDoc(counterDocRef);
                let countBeforeUpdate = 0;
                if (docSnap.exists()) {
                    countBeforeUpdate = docSnap.data().count;
                }

                // 確保 countBeforeUpdate 也尊重 50000 的最小值
                if (countBeforeUpdate < 50000) {
                    countBeforeUpdate = 50000;
                }

                const newCount = countBeforeUpdate + 1;
                await setDoc(counterDocRef, { count: newCount }); // 更新計數器

                showMessage(`數字已更新為: ${newCount}`);
                
                // 更新成功後，重新導向到 Page 2 的 URL，並傳遞動畫所需的數字
                window.location.href = `${window.location.origin}${window.location.pathname}?mode=display&prevCount=${countBeforeUpdate}&targetCount=${newCount}`;
                
                // 因為會跳轉，所以這裡不需要直接呼叫 showPage
                // 頁面重新載入後，window.onload 中的邏輯會根據 URL 參數來顯示正確的頁面和動畫
            } catch (error) {
                showMessage(`更新計數失敗: ${error.message}`, 5000);
                console.error("更新計數失敗:", error);
            } finally {
                enterButton.disabled = false; // 重新啟用按鈕
                enterButton.textContent = '我同意'; // 恢復按鈕文字
            }
        });

        // 返回按鈕點擊事件處理
        backButton.addEventListener('click', () => {
            // 返回第一頁的 URL (移除所有參數)
            window.location.href = `${window.location.origin}${window.location.pathname}`;
        });
    </script>
</body>
</html>
